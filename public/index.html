<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Koroi Drama</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root{
--bg:#0f0f15;
--surface:#1a1a24;
--accent:#ff003c;
--text:#ffffff;
--muted:#aaa;
}
*{box-sizing:border-box}
body{
margin:0;
font-family:'Poppins',sans-serif;
background:var(--bg);
color:var(--text);
}

/* BLOCK */
#blocked{
display:flex;
height:100vh;
justify-content:center;
align-items:center;
flex-direction:column;
background:#000;
}
#blocked h1{color:var(--accent);}

/* HEADER */
header{
display:flex;
justify-content:space-between;
align-items:center;
padding:15px 5%;
background:#111;
position:sticky;
top:0;
z-index:10;
}
header h1{
margin:0;
color:var(--accent);
}
header button{
background:none;
border:1px solid #444;
color:#fff;
padding:6px 12px;
cursor:pointer;
}

/* HERO */
.hero{
height:50vh;
background-size:cover;
background-position:center;
display:flex;
align-items:flex-end;
padding:30px 5%;
}
.hero-content h2{
margin:0 0 10px;
}
.hero-content button{
background:var(--accent);
border:none;
padding:10px 15px;
color:#fff;
cursor:pointer;
}

/* SECTION */
.section{padding:25px 5%}
.row{
display:flex;
gap:15px;
overflow-x:auto;
}
.card{
min-width:160px;
background:var(--surface);
border-radius:8px;
cursor:pointer;
overflow:hidden;
}
.card img{
width:100%;
height:220px;
object-fit:cover;
}
.card p{
margin:0;
padding:8px;
font-size:14px;
}

/* PLAYER */
#playerPage{display:none;padding:20px 5%}
video{
width:100%;
max-height:70vh;
background:black;
}
.episode-list{
display:flex;
flex-wrap:wrap;
gap:8px;
margin-top:15px;
}
.episode{
padding:8px 12px;
background:#222;
cursor:pointer;
border-radius:4px;
}
.episode.active{
background:var(--accent);
}
</style>
</head>

<body>

<div id="blocked">
<h1>Access Denied</h1>
<p>Gunakan link khas untuk masuk.</p>
</div>

<div id="app" style="display:none">

<header>
<h1>Koroi Drama</h1>
<div>
<button onclick="goHome()">Home</button>
<button onclick="logout()">Logout</button>
</div>
</header>

<div id="hero" class="hero"></div>

<div id="homepage"></div>

<div id="playerPage">
<h2 id="videoTitle"></h2>
<video id="videoPlayer" controls></video>
<div class="episode-list" id="episodeList"></div>
</div>

</div>

<script>
const ACCESS_KEY="koroi2026";
const apiBase="/api/proxy";

const params=new URLSearchParams(window.location.search);
const access=params.get("access");

if(access===ACCESS_KEY || sessionStorage.getItem("access")==="true"){
sessionStorage.setItem("access","true");
document.getElementById("blocked").style.display="none";
document.getElementById("app").style.display="block";
history.replaceState({},document.title,window.location.pathname);
loadHome();
}else{
document.getElementById("blocked").style.display="flex";
}

/* API */
async function apiCall(endpoint){
const target=`https://captain.sapimu.au${endpoint}&lang=in`;
const res=await fetch(`${apiBase}?url=${encodeURIComponent(target)}`);
return await res.json();
}

/* HOME */
async function loadHome(){
const container=document.getElementById("homepage");
container.innerHTML="";
document.getElementById("playerPage").style.display="none";
document.getElementById("hero").style.display="flex";

const categories=[
{title:"Terbaru",endpoint:"/dramabox/api/v1/new/1?pageSize=20"},
{title:"Paling Hangat",endpoint:"/dramabox/api/v1/rank/1?pageSize=20"},
{title:"Mesti Tonton",endpoint:"/dramabox/api/v1/classify?pageSize=20&sort=1"}
];

for(let cat of categories){
const res=await apiCall(cat.endpoint);
if(res?.data?.list){
createSection(cat.title,res.data.list);
if(cat.title==="Terbaru"){
setHero(res.data.list[0]);
}
}
}
}

/* HERO */
function setHero(item){
const hero=document.getElementById("hero");
hero.style.backgroundImage=`url(${item.cover})`;
hero.innerHTML=`
<div class="hero-content">
<h2>${item.bookName}</h2>
<button onclick="openDetails(${item.bookId},'${item.bookName.replace(/'/g,"")}')">Tonton Sekarang</button>
</div>`;
}

/* SECTION */
function createSection(title,data){
const section=document.createElement("div");
section.className="section";
section.innerHTML=`<h3>${title}</h3><div class="row"></div>`;
const row=section.querySelector(".row");

data.forEach(item=>{
const card=document.createElement("div");
card.className="card";
card.innerHTML=`<img src="${item.cover}"><p>${item.bookName}</p>`;
card.onclick=()=>openDetails(item.bookId,item.bookName);
row.appendChild(card);
});

document.getElementById("homepage").appendChild(section);
}

/* DETAILS */
async function openDetails(bookId,title){
document.getElementById("homepage").style.display="none";
document.getElementById("hero").style.display="none";
document.getElementById("playerPage").style.display="block";
document.getElementById("videoTitle").textContent=title;

const res=await apiCall(`/dramabox/api/v1/chapters/${bookId}?pageSize=500`);
const episodes=res?.data?.chapterList||[];

const list=document.getElementById("episodeList");
list.innerHTML="";

episodes.forEach(ep=>{
const div=document.createElement("div");
div.className="episode";
div.textContent="Ep "+(ep.chapterIndex+1);
div.onclick=()=>playVideo(bookId,ep.chapterIndex,div);
list.appendChild(div);
});

if(episodes.length>0) playVideo(bookId,0,list.children[0]);
}

/* VIDEO */
let hls;
async function playVideo(bookId,index,element){
const res=await apiCall(`/dramabox/api/v1/watch/${bookId}/${index}`);
const url=res?.data?.videoUrl;
if(!url) return;

document.querySelectorAll(".episode").forEach(e=>e.classList.remove("active"));
if(element) element.classList.add("active");

const video=document.getElementById("videoPlayer");

if(hls){hls.destroy();}

if(Hls.isSupported()){
hls=new Hls();
hls.loadSource(url);
hls.attachMedia(video);
hls.on(Hls.Events.MANIFEST_PARSED,function(){video.play();});
}else if(video.canPlayType("application/vnd.apple.mpegurl")){
video.src=url;
video.addEventListener("loadedmetadata",()=>video.play());
}

/* AUTOPLAY NEXT */
video.onended=function(){
const next=index+1;
const nextBtn=document.querySelector(`[onclick*=",${next}," ]`);
if(nextBtn) nextBtn.click();
};
}

/* NAV */
function goHome(){
loadHome();
}
function logout(){
sessionStorage.removeItem("access");
location.reload();
}
</script>
</body>
</html>
